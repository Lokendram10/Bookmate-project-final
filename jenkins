pipeline{
   agent any
   environment{
       SONAR_HOME= tool"sonarq"
   }
       stages{
          stage('Configure'){
             steps{
             echo"Cloning code from github repo"
             git branch: 'main' , url: 'https://github.com/Lokendram10/Bookmate-project-final'
             }
          }
               stage('SonarQube Analysis'){
             steps{
                echo"sonarqube analysis"
                withSonarQubeEnv('sonarq') {
                     sh "${SONAR_HOME}/bin/sonar-scanner   -DsonarProjectName=Bookmate -Dsonar.projectKey=Bookmate "
                }
             }
          }
               stage('Owasp Dependency Check'){
                 steps {
                  echo "OWASP Dependency Check"
                     dependencyCheck(
                     additionalArguments: '--scan ./',
                     odcInstallation: 'owasp',
                     dependencyCheckPublisher: [pattern: '**/dependency-check-report.xml']
    )
}

          }
               stage('Trivy fs scan'){
             steps{
                echo "Trivy fs scan"
                sh 'trivy fs  --severity HIGH,CRITICAL  --format table --output trivy-fs-report.txt . || true'
             }
          }



             stage('Deploy'){
             steps{
                echo "Deploying bookmate"
                sh 'docker compose up -d --build'
             }
          }


   }
}
